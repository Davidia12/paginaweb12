// index.js
const express = require('express');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
// Para extraer texto de PDF (opcional, si se procesa en el backend)
const pdfParse = require('pdf-parse');

// Aquí podrías requerir la librería del proveedor de TTS que elijas, por ejemplo:
// const googleTTS = require('google-tts-api');

const app = express();
const port = process.env.PORT || 3000;

// Configurar CORS
app.use(cors());
// Configurar multer para manejar uploads (en memoria)
const storage = multer.memoryStorage();
const upload = multer({ storage: storage });

// Endpoint para convertir texto o PDF a voz
app.post('/api/convert', upload.single('pdf'), async (req, res) => {
  try {
    let textToConvert = '';
    
    // Si se envió un archivo PDF, extraer el texto
    if (req.file) {
      const pdfBuffer = req.file.buffer;
      const pdfData = await pdfParse(pdfBuffer);
      textToConvert = pdfData.text;
    } else if (req.body.text) {
      // En otro caso, usar el campo de texto
      textToConvert = req.body.text;
    } else {
      return res.status(400).json({ error: 'No se proporcionó texto ni archivo PDF.' });
    }
    
    // Parámetros de conversión (voz, velocidad, tono, etc.)
    const voice = req.body.voice || 'default';
    const speed = parseFloat(req.body.speed) || 1;
    const pitch = parseFloat(req.body.pitch) || 0;
    
    // Aquí deberías integrar la API del proveedor TTS que elijas.
    // A modo de ejemplo, se simula la conversión generando un audio ficticio.
    // En producción, usarías algo como:
    // const audioUrl = await googleTTS.getAudioUrl(textToConvert, { lang: 'es', slow: speed < 1, host: 'https://translate.google.com' });
    // Y después descargarías o redirigirías el audio generado.
    
    // Simulación: devolvemos un archivo de audio dummy (asegúrate de tener un archivo dummy.mp3 en la carpeta public)
    const dummyAudioPath = path.join(__dirname, 'public', 'dummy.mp3');
    
    // Configurar cabeceras para envío de audio
    res.set({
      'Content-Type': 'audio/mpeg',
      'Content-Disposition': 'attachment; filename="conversion.mp3"'
    });
    
    // En producción, en lugar de enviar un dummy, se enviaría el audio generado
    return res.sendFile(dummyAudioPath);
    
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Error interno al procesar la conversión.' });
  }
});

// Endpoint de prueba (por ejemplo, para el historial, usuarios, etc.)
app.get('/api/test', (req, res) => {
  res.json({ message: 'Backend funcionando correctamente' });
});

app.listen(port, () => {
  console.log(`Servidor corriendo en http://localhost:${port}`);
});
